- name: Bootstrap k3s cluster with Crossplane and ArgoCD
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
  - name: Update apt cache
    apt:
      update_cache: yes
      cache_valid_time: 3600

  - name: Wait for cloud-init to complete
    command: cloud-init status --wait
    changed_when: false

  roles:
  - role: k3s
    when: "'k3s_server' in group_names or 'k3s_agent' in group_names"

- name: Install platform components on k3s server
  hosts: k3s_server[0]
  become: true
  gather_facts: false

  tasks:
  - name: Wait for k3s to be ready
    command: kubectl get nodes
    environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    register: kubectl_result
    until: kubectl_result.rc == 0
    retries: 10
    delay: 10

  roles:
  - role: crossplane
  - role: argocd
  - role: external-secrets

- name: Display cluster information
  hosts: k3s_server[0]
  become: true
  gather_facts: false

  tasks:
  - name: Get cluster nodes
    command: kubectl get nodes -o wide
    environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    register: nodes_output
    changed_when: false

  - name: Display nodes
    debug:
      msg: '{{ nodes_output.stdout_lines }}'

  - name: Get ArgoCD initial admin password
    shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
    environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    register: argocd_password
    changed_when: false
    failed_when: false

  - name: Display access information
    debug:
      msg:
      - ==========================================
      - Cluster Setup Complete!
      - ==========================================
      - 'Kubernetes API: https://{{ ansible_host }}:6443'
      - 'ArgoCD URL: https://{{ ansible_host }}/argocd'
      - 'ArgoCD Username: admin'
      - "ArgoCD Password: {{ argocd_password.stdout | default('Check manually') }}"
      - ''
      - 'To access the cluster:'
      - '  scp azureuser@{{ ansible_host }}:/etc/rancher/k3s/k3s.yaml ~/.kube/config'
      - "  sed -i 's/127.0.0.1/{{ ansible_host }}/g' ~/.kube/config"
      - ==========================================
